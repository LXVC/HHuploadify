/**
 * HHuploadify图片上传插件
 * https://github.com/tangshuang/HHuploadify
 */
(function(d){d.fn.HHuploadify=function(p){var b=d.extend({fileTypeExts:"*.*",uploader:"",auto:!0,method:"post",multi:!0,isSingle:!1,formData:null,fileObjName:"file",fileSizeLimit:2048,showUploadedFilename:!1,showUploadedPercent:!1,showUploadedSize:!1,buttonText:"\u9009\u62e9\u6587\u4ef6",removeTimeout:1E3,itemTemplate:'<div id="${fileID}" class="uploadify-queue-item"><div class="uploadify-progress"><div class="uploadify-progress-bar"></div></div><span class="up_filename">${fileName}</span><a href="javascript:void(0);" class="uploadbtn">\u4e0a\u4f20</a><a href="javascript:void(0);" class="delfilebtn">&times;</a></div>',onUploadStart:null,onUploadSuccess:null,onUploadComplete:null,onUploadError:null,onInit:null,onCancel:null,onClearQueue:null,onDestroy:null,onSelect:null,onQueueComplete:null},p);b.isSingle&&(b.multi=!1);var k={formatFileSize:function(b,d){return b=1048576<b&&!d?(Math.round(100*b/1048576)/100).toString()+"MB":(Math.round(100*b/1024)/100).toString()+"KB"},getFileTypes:function(b){var d=[];b=b.split(";");for(var e=0,h=b.length;e<h;e++)d.push(b[e].split(".").pop());return d},getFile:function(b,d){for(var e=0;e<d.length;e++)if(d[e].index==b)return d[e];return null}},n=null;this.each(function(p,q){var e=d(q),h=d(".uploadify").length+1,c={container:e,filteredFiles:[],init:function(){var a='<input id="select_btn_'+h+'" class="selectbtn" style="display:none;" type="file" name="fileselect[]"',a=a+(b.multi?" multiple":""),a=a+' accept="'+k.getFileTypes(b.fileTypeExts).join(","),a=a+'"/>',a=a+('<a id="file_upload_'+h+'-button" href="javascript:void(0)" class="uploadify-button"><span>'),a=a+b.buttonText,a=a+"</span></a>";e.append('<div class="uploadify">'+('<div id="file_upload_'+h+'-queue" class="uploadify-queue"></div>')+a+'<div class="uploadify-clear"></div></div>');n={instanceNumber:h,upload:function(a){if("*"===a){a=0;for(var b=c.filteredFiles.length;a<b;a++)c._uploadFile(c.filteredFiles[a])}else(a=k.getFile(a,c.filteredFiles))&&c._uploadFile(a)},cancel:function(a){if("*"===a){a=c.filteredFiles.length;for(var g=a-1;0<=g;g--)c._deleteFile(c.filteredFiles[g]);b.onClearQueue&&b.onClearQueue(a)}else(a=k.getFile(a,c.filteredFiles))&&c._deleteFile(a)},disable:function(a){(a?d("file_upload_"+a+"-button"):d("body")).find(".uploadify-button").css("background-color","#888").off("click")},ennable:function(a){var b=a?d("file_upload_"+a+"-button"):d("body");b.find(".uploadify-button").css("background-color","#707070").on("click",function(){b.find(".selectbtn").trigger("click")})},destroy:function(){c.container.html("");c=null;b.onDestroy&&b.onDestroy()},settings:function(a,c){if(1==arguments.length)return b[a];"formData"==a?b.formData=d.extend(b.formData,c):b[a]=c},HHuploadify:function(){var a=arguments[0];a in this&&(Array.prototype.splice.call(arguments,0,1),this[a].apply(this[a],arguments))}};a=this._getInputBtn();0<a.length&&a.change(function(a){c._getFiles(a);b.isSingle&&e.find(".uploadify-button").hide()});e.find(".uploadify-button").on("click",function(){e.find(".selectbtn").trigger("click")});b.onInit&&b.onInit(n)},_filter:function(a){var f=[],c=k.getFileTypes(b.fileTypeExts);if(0<c.length)for(var e=0,h=a.length;e<h;e++){var m=a[e];parseInt(k.formatFileSize(m.size,!0))<=b.fileSizeLimit?0<=d.inArray("*",c)||0<=d.inArray(m.name.split(".").pop(),c)?f.push(m):alert('\u6587\u4ef6 "'+m.name+'" \u7c7b\u578b\u4e0d\u5141\u8bb8\uff01'):alert('\u6587\u4ef6 "'+m.name+'" \u5927\u5c0f\u8d85\u51fa\u9650\u5236\uff01')}return f},_getInputBtn:function(){return e.find(".selectbtn")},_getFileList:function(){return e.find(".uploadify-queue")},_renderFile:function(a){var f=d(b.itemTemplate.replace(/\${fileID}/g,"fileupload_"+h+"_"+a.index).replace(/\${fileName}/g,a.name).replace(/\${fileSize}/g,k.formatFileSize(a.size)).replace(/\${instanceID}/g,e.attr("id")));b.auto?f.find(".uploadbtn").remove():f.find(".uploadbtn").css("display","inline-block");c._getFileList().append(f);if(b.showUploadedSize){var g='<span class="progressnum"><span class="uploadedsize">0KB</span>/<span class="totalsize">${fileSize}</span></span>'.replace(/\${fileSize}/g,k.formatFileSize(a.size));f.find(".uploadify-progress").after(g)}b.showUploadedFilename||f.find(".up_filename").remove();b.showUploadedPercent&&f.find(".uploadify-progress").after('<span class="up_percent">0%</span>');b.onSelect&&b.onSelect(a);if(b.auto)c._uploadFile(a);else f.find(".uploadbtn").on("click",function(){d(this).hasClass(".disabledbtn")||(d(this).addClass(".disabledbtn"),c._uploadFile(a))});f.find(".delfilebtn").on("click",function(){d(this).hasClass(".disabledbtn")||(d(this).addClass(".disabledbtn"),c._deleteFile(a))})},_getFiles:function(a){a=a.target.files;a=c._filter(a);for(var b=e.find(".uploadify-queue .uploadify-queue-item").length,d=0,l=a.length;d<l;d++)a[d].index=++b,a[d].status=0,c.filteredFiles.push(a[d]),c._renderFile(c.filteredFiles[c.filteredFiles.length-1])},_deleteFile:function(a){for(var f=0,g=c.filteredFiles.length;f<g;f++)if(c.filteredFiles[f].index==a.index){c.filteredFiles.splice(f,1);e.find("#fileupload_"+h+"_"+a.index).fadeOut(function(){b.isSingle&&e.find(".uploadify-button").show();d(this).remove()});b.onCancel&&b.onCancel(a);break}},_regulateView:function(a){a=e.find("#fileupload_"+h+"_"+a.index);a.find(".uploadify-progress-bar").css("width","100%");b.showUploadedSize&&a.find(".uploadedsize").text(a.find(".totalsize").text());b.showUploadedPercent&&a.find(".up_percent").text("100%")},onProgress:function(a,c,d){a=e.find("#fileupload_"+h+"_"+a.index+" .uploadify-progress");var l=(c/d*100).toFixed(2)+"%";b.showUploadedSize&&(a.nextAll(".progressnum .uploadedsize").text(k.formatFileSize(c)),a.nextAll(".progressnum .totalsize").text(k.formatFileSize(d)));b.showUploadedPercent&&a.nextAll(".up_percent").text(l);a.children(".uploadify-progress-bar").css("width",l)},_allFilesUploaded:function(){for(var a={uploadsSuccessful:0,uploadsErrored:0},b=0,d=c.filteredFiles.length;b<d;b++){var e=c.filteredFiles[b].status;if(0===e||1===e){a=!1;break}else 2===e?a.uploadsSuccessful++:3===e&&a.uploadsErrored++}return a},_uploadFile:function(a){var f=null;try{f=new XMLHttpRequest}catch(l){f=ActiveXobject("Msxml12.XMLHTTP")}if(f.upload&&(f.upload.onprogress=function(b){c.onProgress(a,b.loaded,b.total)},f.onreadystatechange=function(g){4==f.readyState&&(200==f.status?(c._regulateView(a),a.status=2,b.onUploadSuccess&&b.onUploadSuccess(a,f.responseText),setTimeout(function(){e.find("#fileupload_"+h+"_"+a.index).find(".uploadify-progress").fadeOut(function(){d(this).remove()})},b.removeTimeout),g=JSON.parse(f.responseText),void 0!=g.url&&e.find("#fileupload_"+h+"_"+a.index).addClass("uploaded").css({"background-image":"url("+g.url+")"})):(a.status=3,b.onUploadError&&b.onUploadError(a,f.responseText)),b.onUploadComplete&&b.onUploadComplete(a,f.responseText),b.onQueueComplete&&(g=c._allFilesUploaded())&&b.onQueueComplete(g),c._getInputBtn().val(""))},0===a.status)){a.status=1;b.onUploadStart&&b.onUploadStart(a);f.open(b.method,b.uploader,!0);f.setRequestHeader("X-Requested-With","XMLHttpRequest");var g=new FormData;g.append(b.fileObjName,a);if(b.formData)for(key in b.formData)g.append(key,b.formData[key]);f.send(g)}}};c.init()});return n}})(jQuery);